rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Tier gating: only verified (KYC) users can perform financial operations.
    function isTier1(userId) {
      return request.auth != null
        && request.auth.uid == userId
        && get(/databases/$(database)/documents/users/$(userId)).data.kycStatus == "verified";
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isHrAdmin() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['hr_admin', 'admin', 'super_admin'];
    }

    // Public profiles: safe subset only (no roles, KYC state, or sensitive metadata).
    match /publicProfiles/{userId} {
      allow read, list: if true;
      allow create, update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys().hasOnly([
          "username",
          "displayName",
          "photoURL",
          "country",
          "countryCode",
          "updatedAt"
        ]);
      allow delete: if false;
    }

    // Users: private by default.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list: if isAdmin();
      // Allow only non-sensitive profile/preferences fields to be written by the user.
      // Roles/KYC/risk/limits/financial aggregates must be set by backend services (Admin SDK).
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys().hasOnly([
          "name",
          "firstName",
          "middleName",
          "lastName",
          "photoURL",
          "dateOfBirth",
          "phone",
          "country",
          "countryName",
          "countryCode",
          "street",
          "city",
          "state",
          "zip",
          "location",
          "defaultWalletCurrency",
          "preferences",
          "fcmToken",
          "fcmTokenUpdatedAt",
          "updatedAt"
        ]);

      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "name",
          "firstName",
          "middleName",
          "lastName",
          "photoURL",
          "dateOfBirth",
          "phone",
          "country",
          "countryName",
          "countryCode",
          "street",
          "city",
          "state",
          "zip",
          "location",
          "defaultWalletCurrency",
          "preferences",
          "fcmToken",
          "fcmTokenUpdatedAt",
          "updatedAt"
        ]);
      allow delete: if false;

      match /kycDocuments/{docId} {
        allow create: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.keys().hasAll(["idType", "idNumber", "filePath", "status"])
          && request.resource.data.status == "pending";
        allow read: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if false;
      }

      match /scheduledPayments/{paymentId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if isTier1(userId);
      }

      match /transactions/{txnId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if isTier1(userId);
        allow update, delete: if false;
      }

      match /cards/{cardId} {
        allow read, update, delete: if isTier1(userId);
        allow create: if isTier1(userId)
          && request.resource.data.keys().hasAll(["currency", "cardType", "last4", "expiry", "status"]);
      }

      match /wallets/{walletId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if isTier1(userId)
          && request.resource.data.keys().hasAll(["currency", "balance", "status"]);
        allow update, delete: if isTier1(userId);
      }

      match /notifications/{notifId} {
        allow read, create, update: if request.auth != null && request.auth.uid == userId;
        allow delete: if false;
      }

      match /savings_plans/{planId} {
        allow list, read, create, update: if request.auth != null && request.auth.uid == userId;
        allow delete: if false;
      }

      match /autosave_rules/{ruleId} {
        allow read, create, update: if request.auth != null && request.auth.uid == userId;
        allow delete: if false;
      }

      match /autosave_logs/{logId} {
        allow read, create: if request.auth != null && request.auth.uid == userId;
      }

      match /user_investments/{recordId} {
        allow read, create, update: if request.auth != null && request.auth.uid == userId;
        allow delete: if false;
      }

      match /withdrawals/{withdrawalId} {
        allow read, create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if false;
      }
    }

    // Global Transactions (dispute verification). Consider tightening further for production.
    match /transactions/{transactionId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /escrow/{escrowId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /disputes/{disputeId} {
      allow create: if request.auth != null;
      allow read, list: if request.auth != null &&
        (resource.data.userId == request.auth.uid || request.auth.token.admin == true);
      allow update, delete: if false;
    }

    // Invoices: private; public access must be token-gated at backend.
    match /invoices/{invoiceId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow list: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /businessInvoices/{invoiceId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.createdBy;
      allow list: if request.auth != null;
      allow create: if request.auth != null
        && isTier1(request.auth.uid)
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.businessId is string;
      allow update, delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }

    match /donations/{campaignId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;

      match /contributions/{donationId} {
        allow read: if true;
        allow create: if true;
        allow update, delete: if false;
      }
    }

    match /paymentRequests/{requestId} {
      allow read: if true;
      allow create: if request.auth != null
        && isTier1(request.auth.uid)
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null
        && isTier1(request.auth.uid)
        && resource.data.userId == request.auth.uid;

      match /payments/{paymentId} {
        allow read: if true;
        allow create: if request.auth != null && isTier1(request.auth.uid);
        allow update, delete: if false;
      }
    }

    match /events/{eventId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;

      match /tickets/{ticketId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if false;
      }
    }

    match /investment_listings/{investmentId} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    match /education_articles/{articleId} {
      allow read: if true;
      allow write: if false;
    }

    match /market_news/{newsId} {
      allow read: if true;
      allow write: if false;
    }

    match /kyc_submissions/{submissionId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.status == "submitted"
        && request.resource.data.userId is string
        && request.resource.data.countryCode is string;
      allow update: if isAdmin();
      allow delete: if false;
    }

    match /business_onboarding/{submissionId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow list: if request.auth != null;
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.status == "submitted"
        && request.resource.data.userId is string;
      allow update: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow delete: if false;
    }

    match /jobs/{jobId} {
      allow read: if resource.data.status == 'active' || isHrAdmin();
      allow list: if true;
      allow create: if isHrAdmin()
        && request.resource.data.keys().hasAll(['title', 'department', 'location', 'type', 'status'])
        && request.resource.data.status in ['active', 'closed'];
      allow update: if isHrAdmin() && request.resource.data.status in ['active', 'closed'];
      allow delete: if isHrAdmin();
    }

    match /jobApplications/{applicationId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isHrAdmin());
      allow list: if request.auth != null;
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.keys().hasAll(['jobId', 'userId', 'status'])
        && request.resource.data.status == 'pending';
      allow update: if request.auth != null
        && (request.auth.uid == resource.data.userId || isHrAdmin())
        && request.resource.data.status in ['pending', 'shortlisted', 'rejected', 'accepted'];
      allow delete: if false;
    }

    match /legalDocuments/{docId} {
      allow read: if resource.data.status == 'published' || isAdmin();
      allow list: if true;
      allow create: if isAdmin()
        && request.resource.data.keys().hasAll(['type', 'content', 'status', 'versionNumber'])
        && request.resource.data.type in ['terms', 'privacy']
        && request.resource.data.status in ['draft', 'published', 'archived'];
      allow update: if isAdmin() && request.resource.data.status in ['draft', 'published', 'archived'];
      allow delete: if false;
    }
  }
}
