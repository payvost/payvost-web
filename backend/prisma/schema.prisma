generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                                       String            @id @default(cuid())
  userId                                   String
  // Optional workspace for grouping accounts under PERSONAL/BUSINESS workspaces.
  // Backfilled gradually; existing accounts may remain null.
  workspaceId                               String?
  currency                                 String
  balance                                  Decimal           @default(0) @db.Decimal(20, 8)
  type                                     String            @default("PERSONAL")
  rapydWalletId                            String?
  createdAt                                DateTime          @default(now())
  updatedAt                                DateTime          @updatedAt
  User                                     User              @relation(fields: [userId], references: [id])
  Workspace                                Workspace?        @relation(fields: [workspaceId], references: [id])
  AccountActivity                          AccountActivity[]
  AppliedFee                               AppliedFee[]
  LedgerEntry                              LedgerEntry[]
  fundingSources                           AccountFundingSource[]
  ReferralReward                           ReferralReward[]
  Cards                                    Card[]
  Transfer_Transfer_fromAccountIdToAccount Transfer[]        @relation("Transfer_fromAccountIdToAccount")
  Transfer_Transfer_toAccountIdToAccount   Transfer[]        @relation("Transfer_toAccountIdToAccount")

  @@index([rapydWalletId])
  @@index([userId])
  @@index([workspaceId])
}

model AccountFundingSource {
  id          String   @id @default(cuid())
  accountId   String
  type        String
  provider    String
  providerRef String   @unique
  details     Json
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
}

model PaymentIntentRecord {
  id             String   @id @default(cuid())
  userId         String
  accountId      String
  provider       String
  providerRef    String   @unique
  idempotencyKey String   @unique
  amount         Decimal  @db.Decimal(20, 8)
  currency       String
  status         String
  clientSecret   String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([accountId])
  @@index([userId])
}

model AccountActivity {
  id        String   @id @default(cuid())
  accountId String
  userId    String
  action    String
  ipAddress String?
  metadata  Json?
  createdAt DateTime @default(now())
  Account   Account  @relation(fields: [accountId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@index([accountId])
  @@index([userId])
}

model AppliedFee {
  id                  String                @id @default(cuid())
  transactionId       String
  accountId           String
  amount              Decimal               @db.Decimal(20, 8)
  breakdownJson       String
  createdAt           DateTime              @default(now())
  Account             Account               @relation(fields: [accountId], references: [id])
  Transfer            Transfer              @relation(fields: [transactionId], references: [id])
  AppliedRuleInstance AppliedRuleInstance[]

  @@index([accountId])
  @@index([transactionId])
}

model AppliedRuleInstance {
  id             String     @id @default(cuid())
  appliedFeeId   String
  feeRuleId      String
  amount         Decimal    @db.Decimal(20, 8)
  percentageRate Decimal    @db.Decimal(10, 4)
  createdAt      DateTime   @default(now())
  AppliedFee     AppliedFee @relation(fields: [appliedFeeId], references: [id])
  FeeRule        FeeRule    @relation(fields: [feeRuleId], references: [id])

  @@index([appliedFeeId])
  @@index([feeRuleId])
}

model ChatEvent {
  id          String        @id @default(cuid())
  sessionId   String
  eventType   ChatEventType
  metadata    Json?
  createdAt   DateTime      @default(now())
  ChatSession ChatSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([eventType])
  @@index([sessionId])
}

model ChatMessage {
  id          String      @id @default(cuid())
  sessionId   String
  senderId    String
  content     String
  type        String      @default("text")
  attachments Json?
  metadata    Json?
  isRead      Boolean     @default(false)
  readAt      DateTime?
  readBy      String?
  reactions   Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  ChatSession ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([senderId])
  @@index([sessionId])
  @@index([type])
}

model ChatSession {
  id               String        @id @default(cuid())
  customerId       String
  agentId          String?
  status           ChatStatus    @default(WAITING)
  startedAt        DateTime      @default(now())
  endedAt          DateTime?
  metadata         Json?
  tags             String[]      @default([])
  priority         String?       @default("NORMAL")
  rating           Int?
  notes            String?
  lastMessageAt    DateTime?
  firstResponseAt  DateTime?
  resolvedAt       DateTime?
  customerMetadata Json?
  ChatEvent        ChatEvent[]
  ChatMessage      ChatMessage[]

  @@index([customerId])
  @@index([lastMessageAt])
  @@index([priority])
  @@index([startedAt])
  @@index([status, agentId])
  @@index([tags])
}

model ComplianceAlert {
  id          String   @id @default(cuid())
  type        String
  severity    String
  status      String   @default("PENDING")
  accountId   String?
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Content {
  id              String           @id @default(cuid())
  title           String
  slug            String           @unique
  contentType     ContentType
  status          ContentStatus    @default(DRAFT)
  excerpt         String?
  content         String
  rawContent      Json?
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]
  canonicalUrl    String?
  category        String?
  tags            String[]
  featuredImage   String?
  mediaIds        String[]
  authorId        String
  authorName      String
  coAuthors       String[]
  publishedAt     DateTime?
  scheduledAt     DateTime?
  expiresAt       DateTime?
  version         Int              @default(1)
  parentId        String?
  viewCount       Int              @default(0)
  likeCount       Int              @default(0)
  isPublic        Boolean          @default(true)
  allowComments   Boolean          @default(false)
  language        String           @default("en")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  ContentComment  ContentComment[]
  ContentMedia    ContentMedia[]
  ContentVersion  ContentVersion[]

  @@index([authorId])
  @@index([category])
  @@index([contentType])
  @@index([publishedAt])
  @@index([slug])
  @@index([status])
}

model ContentComment {
  id         String   @id @default(cuid())
  contentId  String
  authorId   String
  authorName String
  comment    String
  parentId   String?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  Content    Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([parentId])
}

model ContentMedia {
  id         String   @id @default(cuid())
  contentId  String?
  fileName   String
  fileUrl    String
  fileType   String
  fileSize   Int
  altText    String?
  caption    String?
  uploadedBy String
  createdAt  DateTime @default(now())
  Content    Content? @relation(fields: [contentId], references: [id])

  @@index([contentId])
  @@index([uploadedBy])
}

model ContentVersion {
  id         String   @id @default(cuid())
  contentId  String
  version    Int
  title      String
  content    String
  excerpt    String?
  authorId   String
  authorName String
  createdAt  DateTime @default(now())
  Content    Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, version])
  @@index([contentId])
}

model Dispute {
  id              String             @id @default(cuid())
  escrowId        String
  raisedBy        String
  raisedByRole    EscrowPartyRole
  againstRole     EscrowPartyRole?
  reason          String
  description     String
  status          DisputeStatus      @default(OPEN)
  resolution      DisputeResolution?
  resolutionNotes String?
  resolvedBy      String?
  resolvedAt      DateTime?
  refundAmount    Decimal?           @db.Decimal(20, 8)
  releaseAmount   Decimal?           @db.Decimal(20, 8)
  respondByDate   DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  Escrow          Escrow             @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  DisputeEvidence DisputeEvidence[]
  DisputeMessage  DisputeMessage[]

  @@index([escrowId])
  @@index([raisedBy])
  @@index([status])
}

model DisputeEvidence {
  id          String   @id @default(cuid())
  disputeId   String
  uploadedBy  String
  fileUrl     String
  fileName    String
  fileType    String?
  fileSize    Int?
  description String?
  createdAt   DateTime @default(now())
  Dispute     Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
}

model DisputeMessage {
  id         String          @id @default(cuid())
  disputeId  String
  senderId   String
  senderRole EscrowPartyRole
  message    String
  isInternal Boolean         @default(false)
  createdAt  DateTime        @default(now())
  Dispute    Dispute         @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
}

model ErrorLog {
  id              String        @id @default(cuid())
  message         String
  errorType       String
  severity        ErrorSeverity @default(MEDIUM)
  status          ErrorStatus   @default(NEW)
  stack           String?
  context         Json?
  method          String?
  path            String?
  query           Json?
  ipAddress       String?
  userAgent       String?
  userId          String?
  correlationId   String?
  environment     String        @default("development")
  release         String?
  occurrenceCount Int           @default(1)
  firstSeenAt     DateTime      @default(now())
  lastSeenAt      DateTime      @default(now())
  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNotes String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([correlationId])
  @@index([createdAt])
  @@index([errorType])
  @@index([severity])
  @@index([status])
  @@index([userId])
}

model Escrow {
  id                 String              @id @default(cuid())
  title              String
  description        String?
  status             EscrowStatus        @default(DRAFT)
  currency           String
  totalAmount        Decimal             @db.Decimal(20, 8)
  platformFee        Decimal             @default(0) @db.Decimal(20, 8)
  platformFeePercent Decimal             @default(2.5) @db.Decimal(5, 2)
  escrowAccountId    String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  acceptedAt         DateTime?
  fundedAt           DateTime?
  completedAt        DateTime?
  expiresAt          DateTime?
  termsAccepted      Boolean             @default(false)
  autoReleaseEnabled Boolean             @default(false)
  autoReleaseDays    Int?
  Dispute            Dispute[]
  EscrowActivity     EscrowActivity[]
  EscrowDocument     EscrowDocument[]
  EscrowParty        EscrowParty[]
  EscrowTransaction  EscrowTransaction[]
  Milestone          Milestone[]

  @@index([createdAt])
  @@index([status])
}

model EscrowActivity {
  id              String           @id @default(cuid())
  escrowId        String
  milestoneId     String?
  type            String
  description     String
  performedBy     String?
  performedByRole EscrowPartyRole?
  metadata        Json?
  createdAt       DateTime         @default(now())
  Escrow          Escrow           @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  Milestone       Milestone?       @relation(fields: [milestoneId], references: [id])

  @@index([createdAt])
  @@index([escrowId])
}

model EscrowDocument {
  id          String   @id @default(cuid())
  escrowId    String
  title       String
  description String?
  fileUrl     String
  fileName    String
  fileType    String?
  fileSize    Int?
  uploadedBy  String
  uploadedAt  DateTime @default(now())
  Escrow      Escrow   @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  @@index([escrowId])
}

model EscrowParty {
  id          String          @id @default(cuid())
  escrowId    String
  userId      String?
  role        EscrowPartyRole
  email       String
  name        String?
  hasAccepted Boolean         @default(false)
  acceptedAt  DateTime?
  invitedAt   DateTime        @default(now())
  Escrow      Escrow          @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([escrowId])
  @@index([userId])
}

model EscrowTransaction {
  id           String     @id @default(cuid())
  escrowId     String
  milestoneId  String?
  type         String
  amount       Decimal    @db.Decimal(20, 8)
  currency     String
  status       String
  transferId   String?
  accountId    String?
  description  String?
  metadata     Json?
  errorMessage String?
  processedBy  String?
  processedAt  DateTime?
  createdAt    DateTime   @default(now())
  Escrow       Escrow     @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  Milestone    Milestone? @relation(fields: [milestoneId], references: [id])

  @@index([escrowId])
  @@index([milestoneId])
  @@index([status])
  @@index([type])
}

model ExternalTransaction {
  id                    String                    @id @default(cuid())
  userId                String
  accountId             String?
  provider              ExternalProvider
  providerTransactionId String?                   @unique
  type                  ExternalTransactionType
  status                ExternalTransactionStatus @default(PENDING)
  amount                Decimal                   @db.Decimal(20, 8)
  currency              String
  recipientDetails      Json?
  metadata              Json?
  errorMessage          String?
  webhookReceived       Boolean                   @default(false)
  webhookData           Json?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  completedAt           DateTime?

  @@index([accountId])
  @@index([providerTransactionId])
  @@index([provider])
  @@index([status])
  @@index([userId])
}

// ============================================
// Outbound Payments: Global-standard primitives
// ============================================

model PaymentOrder {
  id                 String             @id @default(cuid())
  userId             String
  sourceAccountId    String
  type               PaymentOrderType
  status             PaymentOrderStatus @default(DRAFT)

  // Idempotency: unique per user + type.
  idempotencyKey     String

  // Source (payer) amounts
  sourceAmount       Decimal            @db.Decimal(20, 8)
  sourceCurrency     String

  // Target (recipient/provider) amounts
  targetAmount       Decimal            @db.Decimal(20, 8)
  targetCurrency     String

  // Fees (in source currency by default)
  feeAmount          Decimal            @default(0) @db.Decimal(20, 8)
  feeCurrency        String

  // FX snapshot (if any)
  fxRate             Decimal?           @db.Decimal(20, 10)
  fxProvider         String?
  fxSnapshotId       String?

  // Provider routing / correlation
  provider           ExternalProvider?
  providerRef        String?            // provider-side primary reference (e.g. transactionId)
  externalTxId       String?            // optional link to ExternalTransaction.id

  // Product-specific payload (biller/product/recipient details, etc.)
  metadata           Json?

  errorMessage       String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  submittedAt        DateTime?
  completedAt        DateTime?

  attempts           PaymentAttempt[]

  @@unique([userId, type, idempotencyKey])
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([provider, providerRef])
  @@index([sourceAccountId])
}

model PaymentAttempt {
  id                   String              @id @default(cuid())
  paymentOrderId       String
  provider             ExternalProvider
  status               PaymentAttemptStatus @default(CREATED)
  requestPayloadHash   String?
  providerIdempotencyKey String?
  providerRef          String?
  errorMessage         String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  paymentOrder         PaymentOrder        @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)

  @@index([paymentOrderId, createdAt])
  @@index([provider, providerRef])
}

model PaymentTemplate {
  id               String          @id @default(cuid())
  userId           String
  type             PaymentTemplateType
  nickname         String?
  provider         ExternalProvider
  providerEntityId String          // billerId / productId etc. (as string for flexibility)
  fields           Json            // persisted form fields (account/meter number, recipient, etc.)
  lastUsedAt       DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([userId, type, updatedAt])
  @@unique([userId, type, provider, providerEntityId])
}

model PaymentSchedule {
  id           String          @id @default(cuid())
  userId       String
  type         PaymentOrderType
  templateId   String?
  status       PaymentScheduleStatus @default(ACTIVE)
  timezone     String         @default("UTC")
  cron         String         // cron expression (server-side runner interprets this)
  nextRunAt    DateTime
  lastRunAt    DateTime?
  endAt        DateTime?
  metadata     Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([userId, status, nextRunAt])
  @@index([status, nextRunAt])
}

model BulkBatch {
  id            String           @id @default(cuid())
  userId        String
  sourceAccountId String
  status        BulkBatchStatus  @default(DRAFT)
  currency      String
  totalItems    Int              @default(0)
  totalAmount   Decimal          @default(0) @db.Decimal(20, 8)
  metadata      Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  items         BulkBatchItem[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model BulkBatchItem {
  id           String            @id @default(cuid())
  batchId      String
  status       BulkBatchItemStatus @default(PENDING)
  amount       Decimal           @db.Decimal(20, 8)
  currency     String
  details      Json              // per-row payload (recipient/biller/etc.)
  paymentOrderId String?
  errorMessage String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  batch        BulkBatch         @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId, createdAt])
  @@index([status, createdAt])
}

model FeeRule {
  id                  String                @id @default(cuid())
  name                String
  description         String?
  feeType             FeeType
  transactionType     TransactionType
  currency            String
  fixedAmount         Decimal?              @db.Decimal(20, 8)
  percentageRate      Decimal?              @db.Decimal(10, 4)
  minAmount           Decimal?              @db.Decimal(20, 8)
  maxAmount           Decimal?              @db.Decimal(20, 8)
  country             String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  AppliedRuleInstance AppliedRuleInstance[]
}

model Invoice {
  id                String        @id @default(cuid())
  invoiceNumber     String        @unique
  kind              InvoiceKind   @default(INVOICE)
  invoiceType       InvoiceType   @default(USER)
  workspaceId       String?
  userId            String
  businessId        String?
  createdBy         String
  issueDate         DateTime
  dueDate           DateTime
  status            InvoiceStatus @default(DRAFT)
  currency          String
  grandTotal        Decimal       @db.Decimal(20, 8)
  amountPaid        Decimal       @default(0) @db.Decimal(20, 8)
  taxRate           Decimal       @default(0) @db.Decimal(5, 2)
  fromInfo          Json
  toInfo            Json
  items             Json
  paymentMethod     PaymentMethod @default(PAYVOST)
  manualBankDetails Json?
  notes             String?
  // Legacy public access fields. New public access uses InvoicePublicLink tokens.
  isPublic          Boolean       @default(false)
  publicUrl         String?
  pdfUrl            String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  paidAt            DateTime?
  issuedAt          DateTime?
  sentAt            DateTime?
  viewedAt          DateTime?
  voidedAt          DateTime?
  voidReason        String?

  legacySource      InvoiceLegacySource?
  legacyId          String?       @unique

  creditNoteForId   String?
  creditNoteFor     Invoice?      @relation("InvoiceCreditNoteFor", fields: [creditNoteForId], references: [id])
  creditNotes       Invoice[]     @relation("InvoiceCreditNoteFor")

  Workspace         Workspace?    @relation(fields: [workspaceId], references: [id])
  PublicLink        InvoicePublicLink?
  Events            InvoiceEvent[]
  Payments          InvoicePayment[]

  @@index([businessId])
  @@index([createdBy])
  @@index([dueDate])
  @@index([invoiceNumber])
  @@index([invoiceType])
  @@index([isPublic])
  @@index([status])
  @@index([userId])
  @@index([workspaceId])
  @@index([issuedAt])
  @@index([legacySource])
}

model Workspace {
  id              String        @id @default(cuid())
  type            WorkspaceType
  ownerUserId     String
  // For PERSONAL workspaces, businessId is an empty string to allow a single unique workspace per user.
  businessId      String        @default("")
  name            String
  defaultCurrency String        @default("USD")
  defaultLocale   String        @default("en-US")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  Invoices        Invoice[]
  InvoiceSeries   InvoiceSeries[]
  Members         WorkspaceMember[]
  Cards           Card[]
  CardEvents      CardEvent[]
  Accounts        Account[]

  @@unique([type, ownerUserId, businessId])
  @@index([ownerUserId])
  @@index([businessId])
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(OWNER)
  createdAt   DateTime      @default(now())

  Workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  User        User          @relation(fields: [userId], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
}

model Card {
  id               String     @id @default(cuid())
  workspaceId      String
  accountId        String
  label            String
  status           CardStatus @default(ACTIVE)
  network          CardNetwork
  type             CardType   @default(VIRTUAL)
  currency         String

  provider         ExternalProvider @default(RAPYD)
  providerCardId   String

  last4            String
  expMonth         Int?
  expYear          Int?

  createdByUserId  String
  assignedToUserId String?

  // Request idempotency (per workspace + creator)
  idempotencyKey   String?

  metadata         Json?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  Workspace        Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  Account          Account    @relation(fields: [accountId], references: [id])
  CreatedBy        User       @relation("CardCreatedBy", fields: [createdByUserId], references: [id])
  AssignedTo       User?      @relation("CardAssignedTo", fields: [assignedToUserId], references: [id])

  Controls         CardControl[]
  Transactions     CardTransaction[]
  Events           CardEvent[]
  RevealAudits     CardRevealAudit[]

  @@unique([provider, providerCardId])
  @@unique([workspaceId, createdByUserId, idempotencyKey])
  @@index([workspaceId, createdAt])
  @@index([accountId])
  @@index([assignedToUserId])
  @@index([createdByUserId])
}

model CardControl {
  id               String              @id @default(cuid())
  cardId           String
  version          Int                 @default(1)

  spendLimitAmount Decimal?            @db.Decimal(20, 8)
  spendLimitInterval SpendingInterval  @default(MONTHLY)

  allowedCountries String[]            @default([])
  blockedCountries String[]            @default([])
  allowedMcc       String[]            @default([])
  blockedMcc       String[]            @default([])
  merchantAllowlist String[]           @default([])
  merchantBlocklist String[]           @default([])

  onlineAllowed    Boolean             @default(true)
  atmAllowed       Boolean             @default(false)
  contactlessAllowed Boolean           @default(true)

  updatedByUserId  String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  Card             Card                @relation(fields: [cardId], references: [id], onDelete: Cascade)
  UpdatedBy        User                @relation("CardControlUpdatedBy", fields: [updatedByUserId], references: [id])

  @@unique([cardId, version])
  @@index([cardId, updatedAt])
}

model CardTransaction {
  id             String               @id @default(cuid())
  cardId         String
  providerTxId   String               @unique
  kind           CardTransactionKind
  amount         Decimal              @db.Decimal(20, 8)
  currency       String
  merchantName   String?
  merchantCountry String?
  mcc            String?
  status         CardTransactionStatus @default(PENDING)
  happenedAt     DateTime
  raw            Json?
  createdAt      DateTime             @default(now())

  Card           Card                 @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId, happenedAt])
  @@index([status, happenedAt])
}

model CardEvent {
  id          String     @id @default(cuid())
  cardId      String
  workspaceId String
  actorUserId String?
  type        String
  payload     Json?
  createdAt   DateTime   @default(now())

  Card        Card       @relation(fields: [cardId], references: [id], onDelete: Cascade)
  Workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
  @@index([cardId, createdAt])
}

model CardRevealAudit {
  id          String   @id @default(cuid())
  cardId      String
  actorUserId String
  reason      String?
  createdAt   DateTime @default(now())

  Card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId, createdAt])
  @@index([actorUserId, createdAt])
}

model InvoiceSeries {
  id          String    @id @default(cuid())
  workspaceId String
  prefix      String    @default("INV-")
  padding     Int       @default(6)
  nextNumber  Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  Workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId])
  @@index([workspaceId])
}

model InvoicePublicLink {
  id           String   @id @default(cuid())
  invoiceId    String   @unique
  token        String   @unique
  createdAt    DateTime @default(now())
  expiresAt    DateTime?
  revokedAt    DateTime?
  lastViewedAt DateTime?
  viewCount    Int      @default(0)

  Invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([revokedAt])
}

model InvoiceEvent {
  id          String           @id @default(cuid())
  invoiceId   String
  actorUserId String?
  type        InvoiceEventType
  payload     Json?
  createdAt   DateTime         @default(now())

  Invoice     Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([createdAt])
  @@index([type])
}

model InvoicePayment {
  id             String   @id @default(cuid())
  invoiceId       String
  provider        String
  providerRef     String?
  idempotencyKey  String?
  amount          Decimal  @db.Decimal(20, 8)
  currency        String
  status          String
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  Invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([provider])
  @@index([providerRef])
  @@index([idempotencyKey])
}

model KnowledgeBaseArticle {
  id                                          String        @id @default(cuid())
  title                                       String
  content                                     String
  slug                                        String        @unique
  category                                    String
  tags                                        String[]
  status                                      ArticleStatus @default(DRAFT)
  language                                    String        @default("en")
  views                                       Int           @default(0)
  helpfulCount                                Int           @default(0)
  createdById                                 String
  updatedById                                 String?
  publishedAt                                 DateTime?
  createdAt                                   DateTime      @default(now())
  updatedAt                                   DateTime      @updatedAt
  User_KnowledgeBaseArticle_createdByIdToUser User          @relation("KnowledgeBaseArticle_createdByIdToUser", fields: [createdById], references: [id])
  User_KnowledgeBaseArticle_updatedByIdToUser User?         @relation("KnowledgeBaseArticle_updatedByIdToUser", fields: [updatedById], references: [id])

  @@index([createdById])
  @@index([slug])
  @@index([status, category])
}

model LedgerEntry {
  id           String   @id @default(cuid())
  accountId    String
  amount       Decimal  @db.Decimal(20, 8)
  balanceAfter Decimal  @db.Decimal(20, 8)
  type         String
  description  String?
  referenceId  String?
  createdAt    DateTime @default(now())
  Account      Account  @relation(fields: [accountId], references: [id])

  // Idempotency for ledger writes by referenceId. Note: multiple NULL referenceIds are allowed by Postgres.
  @@unique([accountId, referenceId])
  @@index([accountId])
}

model Milestone {
  id                     String              @id @default(cuid())
  escrowId               String
  order                  Int
  title                  String
  description            String?
  amount                 Decimal             @db.Decimal(20, 8)
  status                 MilestoneStatus     @default(PENDING)
  amountFunded           Decimal             @default(0) @db.Decimal(20, 8)
  fundedAt               DateTime?
  requiresApproval       Boolean             @default(true)
  approvedBy             String?
  approvedAt             DateTime?
  releasedAt             DateTime?
  deliverableDescription String?
  deliverableSubmitted   Boolean             @default(false)
  deliverableUrl         String?
  deliverableSubmittedAt DateTime?
  autoReleaseDate        DateTime?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  EscrowActivity         EscrowActivity[]
  EscrowTransaction      EscrowTransaction[]
  Escrow                 Escrow              @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  @@index([escrowId])
  @@index([status])
}

model RateAlert {
  id               String    @id @default(cuid())
  sourceCurrency   String
  targetCurrency   String
  targetRate       Decimal
  email            String?
  pushSubscription Json?
  isActive         Boolean   @default(true)
  notifiedAt       DateTime?
  notifiedCount    Int       @default(0)
  createdAt        DateTime  @default(now())
}

enum FxSnapshotStatus {
  ACCEPTED
  REJECTED
}

enum FxQuoteStatus {
  CREATED
  ACCEPTED
  EXPIRED
  CANCELLED
}

model FxRateSnapshot {
  id                String            @id @default(cuid())
  provider          String
  baseCurrency      String
  providerTimestamp DateTime
  fetchedAt         DateTime          @default(now())
  ratesJson         Json
  status            FxSnapshotStatus  @default(ACCEPTED)
  rejectReason      String?
  createdAt         DateTime          @default(now())
  FxQuote           FxQuote[]

  @@index([provider, status])
  @@index([fetchedAt])
}

model FxQuote {
  id              String        @id @default(cuid())
  userId          String
  fromAccountId   String
  toAccountId     String
  fromCurrency    String
  toCurrency      String
  fromAmount      Decimal       @db.Decimal(20, 8)
  toAmount        Decimal       @db.Decimal(20, 8)
  rateSnapshotId  String
  midRate         Decimal       @db.Decimal(20, 8)
  feeTotal        Decimal       @db.Decimal(20, 8)
  feeBreakdownJson Json
  expiresAt       DateTime
  status          FxQuoteStatus @default(CREATED)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  acceptedAt      DateTime?
  cancelledAt     DateTime?
  FxRateSnapshot  FxRateSnapshot @relation(fields: [rateSnapshotId], references: [id])

  @@index([userId])
  @@index([rateSnapshotId])
  @@index([status, expiresAt])
}

model Recipient {
  id            String   @id @default(cuid())
  userId        String
  name          String
  email         String?
  phone         String?
  payvostUserId String?
  bankName      String?
  accountNumber String?
  swiftCode     String?
  currency      String?
  country       String?
  type          String   @default("EXTERNAL")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  User          User     @relation(fields: [userId], references: [id])

  @@index([payvostUserId])
  @@index([userId])
}

model Referral {
  id                             String           @id @default(cuid())
  referrerId                     String
  referredId                     String           @unique
  referralCodeId                 String
  tier                           ReferralTier     @default(TIER_1)
  parentReferralId               String?
  isActive                       Boolean          @default(true)
  referredKycStatus              String?
  firstTransactionAt             DateTime?
  createdAt                      DateTime         @default(now())
  updatedAt                      DateTime         @updatedAt
  Referral                       Referral?        @relation("ReferralToReferral", fields: [parentReferralId], references: [id])
  other_Referral                 Referral[]       @relation("ReferralToReferral")
  ReferralCode                   ReferralCode     @relation(fields: [referralCodeId], references: [id])
  User_Referral_referredIdToUser User             @relation("Referral_referredIdToUser", fields: [referredId], references: [id])
  User_Referral_referrerIdToUser User             @relation("Referral_referrerIdToUser", fields: [referrerId], references: [id])
  ReferralReward                 ReferralReward[]

  @@index([isActive])
  @@index([referralCodeId])
  @@index([referredId])
  @@index([referrerId])
  @@index([tier])
}

model ReferralCampaign {
  id                   String    @id @default(cuid())
  name                 String
  description          String?
  isActive             Boolean   @default(true)
  signupBonus          Decimal?  @db.Decimal(20, 8)
  signupCurrency       String?
  firstTxBonus         Decimal?  @db.Decimal(20, 8)
  firstTxCurrency      String?
  firstTxMinAmount     Decimal?  @db.Decimal(20, 8)
  tier2Percentage      Decimal?  @db.Decimal(5, 2)
  tier3Percentage      Decimal?  @db.Decimal(5, 2)
  minKycLevel          String?
  eligibleCountries    String[]
  excludedCountries    String[]
  maxReferralsPerUser  Int?
  maxRewardPerUser     Decimal?  @db.Decimal(20, 8)
  maxRewardPerCampaign Decimal?  @db.Decimal(20, 8)
  startDate            DateTime
  endDate              DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
}

model ReferralCode {
  id         String     @id @default(cuid())
  userId     String     @unique
  code       String     @unique
  isActive   Boolean    @default(true)
  usageCount Int        @default(0)
  createdAt  DateTime   @default(now())
  expiresAt  DateTime?
  Referral   Referral[]
  User       User       @relation(fields: [userId], references: [id])

  @@index([code])
  @@index([userId])
}

model ReferralReward {
  id              String               @id @default(cuid())
  referralId      String
  userId          String
  rewardType      ReferralRewardType
  amount          Decimal              @db.Decimal(20, 8)
  currency        String
  status          ReferralRewardStatus @default(PENDING)
  tier            ReferralTier
  description     String?
  metadata        Json?
  accountId       String?
  transferId      String?
  paidAt          DateTime?
  approvedBy      String?
  approvedAt      DateTime?
  cancelledReason String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  expiresAt       DateTime?
  Account         Account?             @relation(fields: [accountId], references: [id])
  Referral        Referral             @relation(fields: [referralId], references: [id])
  User            User                 @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([referralId])
  @@index([rewardType])
  @@index([status])
  @@index([tier])
  @@index([userId])
}

model SavedReply {
  id         String   @id @default(cuid())
  title      String
  content    String
  category   String?
  createdBy  String
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([category])
  @@index([createdBy])
}

model ServiceHealthCheck {
  id           String        @id @default(cuid())
  serviceName  String
  status       ServiceStatus
  responseTime Int?
  uptime       Decimal?      @db.Decimal(5, 2)
  lastChecked  DateTime      @default(now())
  details      Json?
  errorMessage String?
  createdAt    DateTime      @default(now())

  @@index([lastChecked])
  @@index([serviceName])
  @@index([serviceName, lastChecked])
  @@index([status])
}

model SupportTicket {
  id                                    String             @id @default(cuid())
  ticketNumber                          String             @unique
  subject                               String
  description                           String
  status                                TicketStatus       @default(OPEN)
  priority                              TicketPriority     @default(MEDIUM)
  category                              String
  customerId                            String
  assignedToId                          String?
  createdById                           String?
  tags                                  String[]
  metadata                              Json?
  slaDeadline                           DateTime?
  firstResponseAt                       DateTime?
  resolvedAt                            DateTime?
  closedAt                              DateTime?
  createdAt                             DateTime           @default(now())
  updatedAt                             DateTime           @updatedAt
  User_SupportTicket_assignedToIdToUser User?              @relation("SupportTicket_assignedToIdToUser", fields: [assignedToId], references: [id])
  User_SupportTicket_createdByIdToUser  User?              @relation("SupportTicket_createdByIdToUser", fields: [createdById], references: [id])
  User_SupportTicket_customerIdToUser   User               @relation("SupportTicket_customerIdToUser", fields: [customerId], references: [id])
  TicketAttachment                      TicketAttachment[]
  TicketMessage                         TicketMessage[]

  @@index([assignedToId])
  @@index([createdAt])
  @@index([customerId])
  @@index([status, priority])
  @@index([ticketNumber])
}

model SystemIncident {
  id               String           @id @default(cuid())
  title            String
  description      String
  status           IncidentStatus   @default(INVESTIGATING)
  severity         IncidentSeverity @default(MEDIUM)
  affectedServices String[]
  startedAt        DateTime         @default(now())
  resolvedAt       DateTime?
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([severity])
  @@index([startedAt])
  @@index([status])
  @@index([status, severity])
}

model TicketAttachment {
  id            String        @id @default(cuid())
  ticketId      String
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  uploadedById  String
  createdAt     DateTime      @default(now())
  SupportTicket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [uploadedById], references: [id])

  @@index([ticketId])
  @@index([uploadedById])
}

model TicketMessage {
  id            String        @id @default(cuid())
  ticketId      String
  authorId      String
  content       String
  type          MessageType   @default(PUBLIC_REPLY)
  isRead        Boolean       @default(false)
  createdAt     DateTime      @default(now())
  User          User          @relation(fields: [authorId], references: [id])
  SupportTicket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([ticketId])
}

model Transfer {
  id                                      String          @id @default(cuid())
  fromAccountId                           String
  toAccountId                             String
  amount                                  Decimal         @db.Decimal(20, 8)
  currency                                String
  targetAmount                            Decimal?        @db.Decimal(20, 8)
  targetCurrency                          String?
  exchangeRate                            Decimal?        @db.Decimal(20, 8)
  status                                  String
  type                                    TransactionType
  idempotencyKey                          String?         @unique
  description                             String?
  createdAt                               DateTime        @default(now())
  AppliedFee                              AppliedFee[]
  Account_Transfer_fromAccountIdToAccount Account         @relation("Transfer_fromAccountIdToAccount", fields: [fromAccountId], references: [id])
  Account_Transfer_toAccountIdToAccount   Account         @relation("Transfer_toAccountIdToAccount", fields: [toAccountId], references: [id])

  @@index([fromAccountId])
  @@index([toAccountId])
}

model User {
  id                                                          String                 @id
  email                                                       String                 @unique
  name                                                        String?
  role                                                        String                 @default("user")
  kycStatus                                                   String                 @default("pending")
  createdAt                                                   DateTime               @default(now())
  updatedAt                                                   DateTime
  country                                                     String?
  userTier                                                    String                 @default("STANDARD")
  twoFactorEnabled                                            Boolean                @default(false)
  twoFactorMethod                                             String?
  twoFactorSecret                                             String?
  twoFactorPhone                                              String?
  twoFactorBackupCodes                                        String[]
  twoFactorVerified                                           Boolean                @default(false)
  password                                                    String?
  Account                                                     Account[]
  AccountActivity                                             AccountActivity[]
  KnowledgeBaseArticle_KnowledgeBaseArticle_createdByIdToUser KnowledgeBaseArticle[] @relation("KnowledgeBaseArticle_createdByIdToUser")
  KnowledgeBaseArticle_KnowledgeBaseArticle_updatedByIdToUser KnowledgeBaseArticle[] @relation("KnowledgeBaseArticle_updatedByIdToUser")
  Recipient                                                   Recipient[]
  Referral_Referral_referredIdToUser                          Referral?              @relation("Referral_referredIdToUser")
  Referral_Referral_referrerIdToUser                          Referral[]             @relation("Referral_referrerIdToUser")
  ReferralCode                                                ReferralCode?
  ReferralReward                                              ReferralReward[]
  SupportTicket_SupportTicket_assignedToIdToUser              SupportTicket[]        @relation("SupportTicket_assignedToIdToUser")
  SupportTicket_SupportTicket_createdByIdToUser               SupportTicket[]        @relation("SupportTicket_createdByIdToUser")
  SupportTicket_SupportTicket_customerIdToUser                SupportTicket[]        @relation("SupportTicket_customerIdToUser")
  TicketAttachment                                            TicketAttachment[]
  TicketMessage                                               TicketMessage[]

  WorkspaceMemberships                                        WorkspaceMember[]
  CardsCreated                                                Card[]                @relation("CardCreatedBy")
  CardsAssigned                                               Card[]                @relation("CardAssignedTo")
  CardControlsUpdated                                         CardControl[]         @relation("CardControlUpdatedBy")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ChatEventType {
  PAGE_VISIT
  WIDGET_OPENED
  MESSAGE_SENT
  MESSAGE_RECEIVED
  SESSION_STARTED
  SESSION_ENDED
  AGENT_ASSIGNED
  ESCALATED
  RATED
}

enum ChatStatus {
  WAITING
  ACTIVE
  ENDED
}

enum ContentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
  SCHEDULED
}

enum ContentType {
  BLOG
  PRESS_RELEASE
  DOCUMENTATION
  KNOWLEDGE_BASE
}

enum DisputeResolution {
  REFUND_BUYER
  RELEASE_SELLER
  PARTIAL_REFUND
  CUSTOM_SPLIT
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  EVIDENCE_SUBMITTED
  AWAITING_DECISION
  RESOLVED_BUYER
  RESOLVED_SELLER
  RESOLVED_PARTIAL
  CLOSED
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ErrorStatus {
  NEW
  ACKNOWLEDGED
  RESOLVED
  IGNORED
}

enum EscrowPartyRole {
  BUYER
  SELLER
  MEDIATOR
  ADMIN
}

enum EscrowStatus {
  DRAFT
  AWAITING_ACCEPTANCE
  AWAITING_FUNDING
  FUNDED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

enum ExternalProvider {
  RELOADLY
  RAPYD
  PAYSTACK
  FLUTTERWAVE
  STRIPE
}

enum ExternalTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum ExternalTransactionType {
  AIRTIME_TOPUP
  DATA_BUNDLE
  GIFT_CARD
  BILL_PAYMENT
  PAYMENT
  PAYOUT
  VIRTUAL_ACCOUNT_DEPOSIT
  WALLET_TRANSFER
  CARD_ISSUANCE
}

enum PaymentOrderType {
  REMITTANCE
  BILL_PAYMENT
  GIFT_CARD
  BULK_ITEM
}

enum PaymentOrderStatus {
  DRAFT
  QUOTED
  AUTHORIZED
  SUBMITTED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentAttemptStatus {
  CREATED
  SUBMITTED
  SUCCEEDED
  FAILED
}

enum PaymentTemplateType {
  BILL_PAYMENT
  GIFT_CARD
}

enum PaymentScheduleStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum BulkBatchStatus {
  DRAFT
  VALIDATED
  SUBMITTED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum BulkBatchItemStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum FeeType {
  FIXED
  PERCENTAGE
  HYBRID
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  INVESTIGATING
  MONITORING
  RESOLVED
}

enum InvoiceStatus {
  DRAFT
  // Legacy "unpaid" status kept for compatibility with older code and migrations.
  PENDING
  // Global-standard lifecycle statuses (new).
  ISSUED
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  // Legacy; overdue is computed from dueDate + amountDue. Kept for compatibility.
  OVERDUE
  VOID
  CREDITED
  CANCELLED
}

enum InvoiceType {
  USER
  BUSINESS
}

enum InvoiceKind {
  INVOICE
  CREDIT_NOTE
}

enum WorkspaceType {
  PERSONAL
  BUSINESS
}

enum WorkspaceRole {
  OWNER
  ADMIN
  SPEND_MANAGER
  CARDHOLDER
  VIEWER
}

enum CardStatus {
  ACTIVE
  FROZEN
  TERMINATED
}

enum CardNetwork {
  VISA
  MASTERCARD
}

enum CardType {
  VIRTUAL
  PHYSICAL
}

enum SpendingInterval {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  ALL_TIME
}

enum CardTransactionKind {
  AUTH
  CLEARING
  REFUND
  REVERSAL
}

enum CardTransactionStatus {
  PENDING
  COMPLETED
  DECLINED
  REVERSED
}

enum InvoiceLegacySource {
  FIRESTORE_INVOICES
  FIRESTORE_BUSINESS_INVOICES
  NATIVE
}

enum InvoiceEventType {
  INVOICE_CREATED
  INVOICE_ISSUED
  INVOICE_SENT
  INVOICE_VIEWED
  PAYMENT_APPLIED
  INVOICE_VOIDED
  CREDIT_NOTE_ISSUED
  PDF_RENDERED
}

enum MessageType {
  PUBLIC_REPLY
  INTERNAL_NOTE
}

enum MilestoneStatus {
  PENDING
  AWAITING_FUNDING
  FUNDED
  UNDER_REVIEW
  APPROVED
  RELEASED
  DISPUTED
  CANCELLED
}

enum PaymentMethod {
  PAYVOST
  MANUAL
  STRIPE
  RAPYD
}

enum ReferralRewardStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
  EXPIRED
}

enum ReferralRewardType {
  SIGNUP_BONUS
  FIRST_TRANSACTION
  MONTHLY_ACTIVE
  TIER_UPGRADE
  CUSTOM
}

enum ReferralTier {
  TIER_1
  TIER_2
  TIER_3
}

enum ServiceStatus {
  OPERATIONAL
  DEGRADED_PERFORMANCE
  MAJOR_OUTAGE
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TransactionType {
  INTERNAL_TRANSFER
  EXTERNAL_TRANSFER
  CARD_PAYMENT
  ATM_WITHDRAWAL
  DEPOSIT
  CURRENCY_EXCHANGE
}
