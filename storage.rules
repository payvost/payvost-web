rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ‚ùå Default: deny all
    match /{allPaths=**} {
      allow read, write: if false;
    }

// üè¢ Business verification documents (matches your current upload path)
match /business_verification/{userId}/{docType}/{fileName} {
  // Authenticated user can upload
  allow create: if request.auth != null
                && request.auth.uid == userId
                && request.resource.size < 10 * 1024 * 1024
                && request.resource.contentType.matches('image/.*|application/pdf');

  // User can read their own uploaded documents
  allow read: if request.auth != null && request.auth.uid == userId;

  // Admins can read for verification
  allow read: if request.auth != null && request.auth.token.admin == true;

  // Prevent updates/deletes by user
  allow update, delete: if false;
}

// üè¢ Business logos
match /business_logos/{userId}/{fileName} {
  // Authenticated user can upload their logo
  allow create: if request.auth != null
                && request.auth.uid == userId
                && request.resource.size < 5 * 1024 * 1024
                && request.resource.contentType.matches('image/.*');

  // User can read their own logo
  allow read: if request.auth != null && request.auth.uid == userId;

  // Admins can read for verification if needed
  allow read: if request.auth != null && request.auth.token.admin == true;

  // Prevent updates/deletes by user
  allow update, delete: if false;
}

// üßæ Invoice logos (for branding on invoices)
match /invoice_logos/{userId}/{fileName} {
  // Authenticated user can upload their invoice logo
  allow create: if request.auth != null
                && request.auth.uid == userId
                && request.resource.size < 5 * 1024 * 1024
                && request.resource.contentType.matches('image/.*');

  // User can read their own logo
  allow read: if request.auth != null && request.auth.uid == userId;

  // Admins can read if needed for invoice verification
  allow read: if request.auth != null && request.auth.token.admin == true;

  // Prevent updates/deletes by user
  allow update, delete: if false;
}


    // üë§ Profile pictures
    match /profile_pictures/{userId}/{fileName} {
      // Everyone can view, but only the user can upload/update
      allow read: if true;
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }

    // ü™™ ID Documents (KYC)
    match /id_documents/{userId}/{fileName} {
      // Only the authenticated user can upload
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.size < 10 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*|application/pdf');

      // User can read their own uploads
      allow read: if request.auth != null && request.auth.uid == userId;

      // üîê Admins can also read for verification
      allow read: if request.auth != null && request.auth.token.admin == true;

      // Prevent tampering or deletion
      allow update, delete: if false;
    }

    // ü™™ KYC Submissions (for tier upgrades)
    match /kyc_submissions/{userId}/{submissionId}/{docType}/{fileName} {
      // Authenticated user can upload their own KYC documents
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*|application/pdf');

      // User can read their own uploaded documents
      allow read: if request.auth != null && request.auth.uid == userId;

      // üîê Admins can read for verification
      allow read: if request.auth != null && request.auth.token.admin == true;

      // Prevent deletion by user (documents should be immutable once uploaded)
      allow delete: if false;
    }

    // üéÅ Donation campaign media
    match /donation_media/{userId}/{allPaths=**} {
      allow read;
      
      // Allow upload & replace
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*|video/.*');

      // Allow delete of their own media
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // üßæ Invoice PDFs (pre-generated and stored)
    match /invoice_pdfs/{allPaths=**} {
      // Public invoices: anyone can read
      // Private invoices: only owner can read
      // Server can write (via Admin SDK)
      allow read: if true; // Public access - we'll use signed URLs for security
      allow write: if false; // Only server can write via Admin SDK
    }
    
    // üßæ Legacy invoices path (for backward compatibility)
    match /invoices/{userId}/{allPaths=**} {
      // Only the owner can upload/read their invoices
      allow read, write: if request.auth != null
                         && request.auth.uid == userId
                         && request.resource.size < 10 * 1024 * 1024
                         && request.resource.contentType.matches('application/pdf|image/.*');
    }
    
    // üì∏ Event banners
    match /event_banners/{userId}/{allPaths=**} {
      allow read: if true; // public can see banners

      // Only event creator (owner) can upload images
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');

      // Allow delete by the owner
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // üìÇ Disputes evidence
    match /disputes/{userId}/{fileName} {
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.size < 5 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*|application/pdf');

      allow read: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // üé´ Support ticket attachments
    match /support_attachments/{userId}/{fileName} {
      // Users can upload attachments to their own folder
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024 // 10MB limit
                   && request.resource.contentType.matches('image/.*|application/pdf|application/.*|text/.*|application/vnd.openxmlformats-officedocument.*|application/vnd.ms-excel|application/zip');
      
      // Users can read their own attachments
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Support agents can read all attachments (for ticket support)
      allow read: if request.auth != null 
                  && (request.auth.token.role != null 
                      && (request.auth.token.role.matches('support_.*') 
                          || request.auth.token.role == 'admin' 
                          || request.auth.token.role == 'super_admin'));
    }
    
    // üí¨ Chat attachments
    match /chat_attachments/{sessionId}/{fileName} {
      // Allow uploads for chat participants
      allow write: if request.auth != null 
                   && request.resource.size < 5 * 1024 * 1024 // 5MB limit
                   && request.resource.contentType.matches('image/.*|application/pdf|application/.*|text/.*');
      
      // Chat participants can read
      allow read: if request.auth != null;
    }
  }
}
