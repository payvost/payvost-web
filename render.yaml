services:
  # Main Backend API Gateway (includes Support Service and all other services)
  - type: web
    name: payvost-backend-gateway
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend && npm install --include=dev && npm run build
    startCommand: cd backend && npm start
    envVars:
      - key: PORT
        value: 3001
      - key: DATABASE_URL
        sync: false  # Set to your Neon database connection string in Render Dashboard
      - key: FIREBASE_SERVICE_ACCOUNT_KEY
        sync: false  # Firebase service account JSON (as string)
      - key: FIREBASE_DATABASE_URL
        sync: false  # Optional: Firebase Realtime Database URL
      - key: FRONTEND_URL
        sync: false  # Comma-separated list of allowed origins (e.g., "https://www.payvost.com,https://payvost.com")
      - key: NODE_ENV
        value: production
      - key: REDIS_URL
        sync: false  # Optional: Redis connection URL if using Redis
      - key: MAILGUN_API_KEY
        sync: false  # Optional: If using Mailgun for emails
      - key: MAILGUN_DOMAIN
        sync: false  # Optional: Mailgun domain
      - key: TWILIO_ACCOUNT_SID
        sync: false  # Optional: If using Twilio for SMS
      - key: TWILIO_AUTH_TOKEN
        sync: false  # Optional: Twilio auth token
      - key: TWILIO_FROM_NUMBER
        sync: false  # Optional: Twilio phone number
      - key: JWT_SECRET
        sync: false  # Optional: JWT secret for token signing
      - key: OPENAI_API_KEY
        sync: false  # Optional: OpenAI API key for AI chat features
      - key: PDF_SERVICE_URL
        sync: false  # URL of PDF service (set after deployment)
      - key: EMAIL_SERVICE_URL
        sync: false  # URL of Email service (set after deployment)
      - key: ADMIN_STATS_SERVICE_URL
        sync: false  # URL of Admin Stats service (set after deployment)
      - key: WEBHOOK_SERVICE_URL
        sync: false  # URL of Webhook service (set after deployment)
      - key: CURRENCY_SERVICE_URL
        sync: false  # URL of Currency service (set after deployment)
      - key: FRAUD_SERVICE_URL
        sync: false  # URL of Fraud service (set after deployment)
      - key: CORE_BANKING_SERVICE_URL
        sync: false  # URL of Core Banking service (set after deployment)
      - key: RATE_ALERT_SERVICE_URL
        sync: false  # URL of Rate Alert service (set after deployment)
      - key: NOTIFICATION_SERVICE_URL
        sync: false  # URL of Notification service (set after deployment)
      - key: INTERNAL_SERVICE_TOKEN
        sync: false  # Internal service authentication token for service-to-service communication

  # Rate Alert Monitor Service (Background Worker / Cron Job)
  - type: web
    name: payvost-rate-alert-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/rate-alert-service && npm install --include=dev && npm run build
    startCommand: cd backend/services/rate-alert-service && npm start
    envVars:
      - key: RATE_ALERT_SERVICE_PORT
        value: 3009
      - key: DATABASE_URL
        sync: false  # Set to your Neon database connection string in Render Dashboard
      - key: MAILGUN_API_KEY
        sync: false
      - key: MAILGUN_DOMAIN
        sync: false
      - key: VAPID_PUBLIC_KEY
        sync: false
      - key: VAPID_PRIVATE_KEY
        sync: false
      - key: VAPID_EMAIL
        value: alerts@payvost.com
      - key: OPEN_EXCHANGE_RATES_APP_ID
        sync: false
      - key: AUTO_RUN_ON_STARTUP
        value: "false"
      - key: NODE_ENV
        value: production

  # Currency Service
  - type: web
    name: payvost-currency-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/currency-service && NODE_ENV=development npm install && npm run build
    startCommand: cd backend/services/currency-service && npm start
    envVars:
      - key: CURRENCY_SERVICE_PORT
        value: 3010
      - key: OPEN_EXCHANGE_RATES_APP_ID
        sync: false
      - key: NODE_ENV
        value: production

  # Fraud Detection Service
  - type: web
    name: payvost-fraud-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/fraud-service && NODE_ENV=development npm install && npm run build
    startCommand: cd backend/services/fraud-service && npm start
    envVars:
      - key: FRAUD_SERVICE_PORT
        value: 3011
      - key: DATABASE_URL
        sync: false  # Set to your Neon database connection string in Render Dashboard
      - key: INTERNAL_API_KEY
        sync: false
      - key: NODE_ENV
        value: production

  # Core Banking Service
  - type: web
    name: payvost-core-banking-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/core-banking-service && npm install --include=dev && npm run build
    startCommand: cd backend/services/core-banking-service && npm start
    envVars:
      - key: CORE_BANKING_SERVICE_PORT
        value: 3012
      - key: DATABASE_URL
        sync: false  # Set to your Neon database connection string in Render Dashboard
      - key: INTERNAL_API_KEY
        sync: false
      - key: NODE_ENV
        value: production

  # Webhook Service
  - type: web
    name: payvost-web-hook-services
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/webhooks && npm install --include=dev && npm run build
    startCommand: cd backend/services/webhooks && npm start
    envVars:
      - key: WEBHOOK_SERVICE_PORT
        value: 3008
      - key: DATABASE_URL
        sync: false  # Set to your Neon database connection string in Render Dashboard
      - key: FIREBASE_SERVICE_ACCOUNT_KEY
        sync: false  # Firebase service account JSON (as string)
      - key: RELOADLY_WEBHOOK_SECRET
        sync: false  # Reloadly webhook secret for signature verification
      - key: NODE_ENV
        value: production

  # Admin Stats Service
  - type: web
    name: payvost-admin-stat-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/admin-stats && npm install --include=dev && npm run build
    startCommand: cd backend/services/admin-stats && npm start
    envVars:
      - key: ADMIN_STATS_SERVICE_PORT
        value: 3007
      - key: FIREBASE_SERVICE_ACCOUNT_KEY
        sync: false  # Firebase service account JSON (as string)
      - key: NODE_ENV
        value: production

  # PDF Generator Service
  - type: web
    name: payvost-pdf-generator
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd services/pdf-generator && npm install
    startCommand: cd services/pdf-generator && npm start
    envVars:
      - key: PORT
        value: 8080
      - key: VERCEL_BASE_URL
        sync: false  # Optional: Vercel base URL for invoice data fetching
      - key: NODE_ENV
        value: production

  # Email Service
  - type: web
    name: payvost-email-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/email && npm install --include=dev && npm run build
    startCommand: cd backend/services/email && npm start
    envVars:
      - key: EMAIL_SERVICE_PORT
        value: 3006
      - key: MAILGUN_API_KEY
        sync: false  # Mailgun API key
      - key: MAILGUN_DOMAIN
        sync: false  # Mailgun domain
      - key: MAILGUN_FROM_EMAIL
        sync: false  # From email address (e.g., no-reply@payvost.com)
      - key: NODE_ENV
        value: production

  # Notification Service (Webhook-based notifications)
  - type: web
    name: payvost-notification-service
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/notification-service && npm install --include=dev && npm run build
    startCommand: cd backend/services/notification-service && npm start
    envVars:
      - key: NOTIFICATION_SERVICE_PORT
        value: 3005
      - key: EMAIL_SERVICE_URL
        value: https://payvost-email-service-3vnx.onrender.com
      - key: INTERNAL_API_KEY
        sync: false  # Optional: API key for internal service communication
      - key: NODE_ENV
        value: production

  # Notification Processor (Email delivery + Cron jobs for reminders)
  - type: web
    name: payvost-notification-processor
    autoDeploy: false
    env: node
    region: oregon
    plan: starter
    buildCommand: cd backend/services/notification-processor && npm install --include=dev && npm run build
    startCommand: cd backend/services/notification-processor && npm start
    envVars:
      - key: PORT
        value: 3006
      - key: DATABASE_URL
        sync: false  # Set to your Neon database connection string in Render Dashboard
      - key: DIRECT_URL
        sync: false  # Direct database URL for Prisma (optional, for better performance)
      - key: MAILGUN_API_KEY
        sync: false  # Mailgun API key for email delivery
      - key: MAILGUN_DOMAIN
        sync: false  # Mailgun domain (e.g., mg.payvost.com)
      - key: MAILGUN_FROM_EMAIL
        sync: false  # From email address (e.g., notifications@payvost.com)
      - key: INTERNAL_SERVICE_TOKEN
        sync: false  # Internal service authentication token (must match gateway token)
      - key: NODE_ENV
        value: production
      - key: LOG_LEVEL
        value: info
      - key: INVOICE_REMINDER_ENABLED
        value: "true"
      - key: INVOICE_REMINDER_SCHEDULE
        value: "0 9 * * *"  # Run daily at 9 AM UTC
      - key: TIMEZONE
        value: UTC

# Optional: Cron Job for Rate Alert Monitor (alternative to always-on service)
# Uncomment if you prefer scheduled execution instead of always-on service
# cronJobs:
#   - name: payvost-rate-alert-cron
#     schedule: "*/15 * * * *"  # Every 15 minutes
#     service: payvost-rate-alert-service
#     command: curl -X POST http://localhost:3009/run

